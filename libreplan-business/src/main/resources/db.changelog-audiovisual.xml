<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="add-table-budget_line_template" author="jaragunde">
        <comment>
            A subclass of OrderLineTemplate called BudgetLineTemplate has been added, it
            contains new fields. These fields are saved to a new table called budget_line_template.
        </comment>
        <createTable tableName="budget_line_template">
            <column name="budget_line_template_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="budget_line_template_pkey"/>
            </column>
            <column name="cost_or_salary" type="DECIMAL(19,2)"/>
            <column name="duration" type="INTEGER"/>
            <column name="quantity" type="INTEGER"/>
            <column name="indemnization_salary" type="DECIMAL(19,2)"/>
            <column name="holiday_salary" type="DECIMAL(19,2)"/>
            <column name="budget_line_type" type="INTEGER"/>
        </createTable>
    </changeSet>

    <changeSet id="add-table-budget_template" author="jaragunde">
        <comment>
            A subclass of OrderTemplate called BudgetTemplate has been added. It doesn't contain
            new fields but the entity will be used to list the Templates differentiating them from
            Budgets, which are also children of OrderTemplate.
        </comment>
        <createTable tableName="budget_template">
            <column name="budget_template_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="budget_template_pkey"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="add-foreign-key-constraints-budget_template" author="jaragunde">
        <comment>
            Add foreign key constraints between the base class OrderElementTemplate and its children
            classes BudgetLineTemplate and BudgetTemplate.
        </comment>
        <addForeignKeyConstraint constraintName="fk_budget_line_template_order_element_template"
            baseTableName="budget_line_template" baseColumnNames="budget_line_template_id"
            referencedTableName="order_element_template" referencedColumnNames="id"
            />
        <addForeignKeyConstraint constraintName="fk_budget_template_order_element_template"
            baseTableName="budget_template" baseColumnNames="budget_template_id"
            referencedTableName="order_element_template" referencedColumnNames="id"
            />
    </changeSet>

    <changeSet id="add-code-order_element_template" author="jaragunde">
        <comment>
            The code attribute was removed from order_element_template table in master,
            but in audiovisual branch it is needed.
        </comment>
        <addColumn tableName="order_element_template">
            <column name="code" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet author="smontes" id="initial-creation-table-filming-progress">
        <createTable tableName="filming_progress">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="filming_progress_pkey"/>
            </column>
            <column name="version" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="DATE"/>
            <column name="end_date" type="DATE"/>
            <column name="progress_granularity" type="INTEGER"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="id" baseTableName="filming_progress"
            constraintName="fk_filming_progress_per_order" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="order_element_id"
            referencedTableName="order_table" referencesUniqueColumn="false"/>
    </changeSet>

    <changeSet author="smontes" id="initial-database-creation-initial-progress-forecast">
        <createTable tableName="initial_progress_forecast">
            <column name="filming_progress_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="day" type="DATE"/>
            <column name="scenes" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="filming_progress_id, day" constraintName="scenes_per_day_pkey" tableName="initial_progress_forecast"/>
        <addForeignKeyConstraint baseColumnNames="filming_progress_id" baseTableName="initial_progress_forecast"
            constraintName="fk_initial_progress_forecast_per_filming" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="filming_progress"
            referencesUniqueColumn="false"/>
    </changeSet>

    <changeSet author="smontes" id="initial-database-creation-progress-forecast">
        <createTable tableName="progress_forecast">
            <column name="filming_progress_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="day" type="DATE"/>
            <column name="scenes" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="filming_progress_id, day" constraintName="scenes_per_day_forecast_pkey" tableName="progress_forecast"/>
        <addForeignKeyConstraint baseColumnNames="filming_progress_id" baseTableName="progress_forecast"
            constraintName="fk_progress_forecast_per_filming" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="filming_progress"
            referencesUniqueColumn="false"/>
    </changeSet>

    <changeSet author="smontes" id="initial-database-creation-real-progress">
        <createTable tableName="real_progress">
            <column name="filming_progress_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="day" type="DATE"/>
            <column name="scenes" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="filming_progress_id, day" constraintName="real_scenes_per_day_pkey" tableName="real_progress"/>
        <addForeignKeyConstraint baseColumnNames="filming_progress_id" baseTableName="real_progress"
            constraintName="fk_real_progress_per_filming" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="filming_progress"
            referencesUniqueColumn="false"/>
    </changeSet>

    <changeSet id="add-table-budget-and-relation-with-order" author="jaragunde">
        <comment>
            A subclass of OrderTemplate called Budget has been added. It doesn't contain
            new fields but the entity will be used to differentiate from
            BudgetTemplates, which are also children of OrderTemplate.
            A one-to-one relation between Budget and Order has to be set.
        </comment>
        <createTable tableName="budget">
            <column name="budget_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="budget_pkey"/>
            </column>
            <column name="order_element_id" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_budget_order_element_template"
            baseTableName="budget" baseColumnNames="budget_id"
            referencedTableName="order_element_template" referencedColumnNames="id"
            />
        <addForeignKeyConstraint constraintName="fk_budget_order"
            baseTableName="budget" baseColumnNames="order_element_id"
            referencedTableName="order_table" referencedColumnNames="order_element_id"
            />
    </changeSet>

    <changeSet id="remove-calendar-from-order_template" author="jaragunde">
        <comment>Remove column base_calendar_id in order_template table</comment>
        <dropColumn tableName="order_template" columnName="base_calendar_id" />
    </changeSet>

	<changeSet id="add-column-type-in-filming-progress-table" author="smontes">
        <comment>add column type in filming_progress table</comment>
        <addColumn tableName="filming_progress">
            <column name="type" type="INTEGER"/>
        </addColumn>
    </changeSet>

    <changeSet id="remove-progress-granularity-from-filming-progress" author="smontes">
        <comment>Remove column progress_granularity in filming_progress table</comment>
        <dropColumn tableName="filming_progress" columnName="progress_granularity" />
    </changeSet>
</databaseChangeLog>
